<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Overlap Meter — Life Timeline Guess (Canvas)</title>
    <style>
        :root {
            --bg: #0f1115;
            --card: #161a24;
            --ink: #e9ecf1;
            --muted: #a6aec4;
            --accent: #5e9dc8;
            --good: #35c76d;
            --bad: #ff5a5a;
            --warn: #f2b84b;
            --rail: #22283a;
            --rail2: #1c2130;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
            display: grid;
            place-items: center;
            padding: 16px;
        }

        .app {
            width: 100%;
            max-width: 900px;
            background: var(--card);
            border: 1px solid #242a3d;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, .35);
            padding: 18px;
        }

        header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 6px
        }

        h1 {
            font-size: 18px;
            margin: 0
        }

        .sub {
            color: var(--muted);
            font-size: 13px
        }

        .people {
            display: grid;
            gap: 10px;
            margin: 12px 0
        }

        .person {
            background: linear-gradient(180deg, var(--rail2), var(--rail));
            border: 1px solid #262d42;
            border-radius: 12px;
            padding: 12px;
            display: grid;
            gap: 6px;
        }

        .person .name {
            font-weight: 600
        }

        .person .years {
            color: var(--muted);
            font-size: 13px
        }

        .viz-wrap {
            margin: 8px 0 12px;
            border: 1px solid #1e2435;
            border-radius: 12px;
            background: #101420;
        }

        canvas {
            display: block;
            width: 100%;
            height: 140px;
            border-radius: 12px
        }

        .years-scale {
            display: flex;
            justify-content: space-between;
            color: var(--muted);
            font-size: 12px;
            margin-top: 6px
        }

        .controls {
            display: grid;
            gap: 10px;
            background: #121726;
            border: 1px solid #262d42;
            border-radius: 12px;
            padding: 12px;
        }

        .slider-row {
            display: grid;
            gap: 6px
        }

        .label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: var(--muted)
        }

        input[type="range"] {
            appearance: none;
            /* Standard */
            -webkit-appearance: none;
            /* Safari/Chrome */
            -moz-appearance: none;
            /* Firefox */
            width: 100%;
            height: 28px;
            background: transparent;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: #1a2133;
            border-radius: 6px;
            border: 1px solid #27304a;
        }

        input[type="range"]::-moz-range-track {
            height: 6px;
            background: #1a2133;
            border-radius: 6px;
            border: 1px solid #27304a;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid #0b0f18;
            margin-top: -9px;
            box-shadow: 0 0 0 2px rgba(94, 157, 200, .2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid #0b0f18;
            box-shadow: 0 0 0 2px rgba(94, 157, 200, .2);
        }

        .btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        button {
            background: var(--accent);
            color: #0b0f18;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        button.secondary {
            background: #21283c;
            color: var(--ink);
            border: 1px solid #2b3350
        }

        .result {
            margin-top: 10px;
            padding: 12px;
            border: 1px solid #2a3250;
            border-radius: 12px;
            background: #101625;
            display: grid;
            gap: 6px;
        }

        .score {
            font-weight: 700
        }

        .muted {
            color: var(--muted)
        }

        a {
            color: var(--accent);
            text-decoration: none
        }

        .err {
            color: var(--bad);
            font-size: 13px
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <h1>Overlap Meter</h1>
            <div class="sub">Guess the overlap between two people’s lives using a double slider. Canvas-rendered
                timeline.</div>
        </header>

        <div id="status" class="sub"></div>

        <div class="people" id="people"></div>

        <div class="viz-wrap">
            <canvas id="viz" height="140"></canvas>
        </div>
        <div class="years-scale" id="scale"></div>

        <div class="controls">
            <div class="slider-row">
                <div class="label"><span>Overlap start (your guess)</span><span id="startVal">—</span></div>
                <input id="startSlider" type="range" min="1900" max="2025" value="1950" step="1" />
            </div>
            <div class="slider-row">
                <div class="label"><span>Overlap end (your guess)</span><span id="endVal">—</span></div>
                <input id="endSlider" type="range" min="1900" max="2025" value="2000" step="1" />
            </div>
            <div class="btns">
                <button id="submit">Check overlap</button>
                <button id="again" class="secondary">New round</button>
            </div>
            <div id="result" class="result" style="display:none"></div>
        </div>
    </div>

    <script>
        // ---------- Utilities ----------
        const fmtYear = y => (y === null || y === undefined) ? "—" : String(y);
        const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        function overlapYears(b1, d1, b2, d2) {
            const start = Math.max(b1, b2);
            const end = Math.min(d1, d2);
            return Math.max(0, Math.floor(end - start));
        }

        // ---------- Data fetch via Wikimedia/Wikidata APIs (CORS-friendly) ----------
        const WIKI_API = 'https://en.wikipedia.org/w/api.php?origin=*';
        const WDATA_API = 'https://www.wikidata.org/w/api.php?origin=*';

        // --- Pageviews helpers ---
        const PAGEVIEWS_API = 'https://wikimedia.org/api/rest_v1/metrics/pageviews/per-article';
        const PAGEVIEWS_PROJECT = 'en.wikipedia.org';
        const PAGEVIEWS_ACCESS = 'all-access';
        const PAGEVIEWS_AGENT = 'user';

        // YYYYMMDD in UTC
        function yyyymmdd(date) {
            const y = date.getUTCFullYear();
            const m = String(date.getUTCMonth() + 1).padStart(2, '0');
            const d = String(date.getUTCDate()).padStart(2, '0');
            return `${y}${m}${d}`;
        }

        // Sum views for last N days (default 60). Ends yesterday to avoid partial today.
        async function getViewsLastNDays(title, days = 60) {
            // Titles must use underscores in the REST API path
            const article = encodeURIComponent(title.replace(/ /g, '_'));
            const endDate = new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate() - 1));
            const startDate = new Date(endDate);
            startDate.setUTCDate(startDate.getUTCDate() - (days - 1));

            const url = `${PAGEVIEWS_API}/${PAGEVIEWS_PROJECT}/${PAGEVIEWS_ACCESS}/${PAGEVIEWS_AGENT}/${article}/daily/${yyyymmdd(startDate)}/${yyyymmdd(endDate)}`;
            const r = await fetch(url);
            if (!r.ok) return 0; // be forgiving on errors
            const j = await r.json();
            const items = j?.items || [];
            let sum = 0;
            for (const it of items) sum += (it?.views || 0);
            return sum;
        }

        async function getRandomPages(limit = 40) {
            const url = `${WIKI_API}&action=query&list=random&rnnamespace=0&rnlimit=${limit}&format=json`;
            const r = await fetch(url);
            if (!r.ok) throw new Error('random fetch failed');
            const j = await r.json();
            return j?.query?.random || [];
        }

        async function getPageProps(pageids) {
            const ids = pageids.join('|');
            const url = `${WIKI_API}&action=query&prop=pageprops|info&inprop=url&ppprop=wikibase_item&pageids=${ids}&format=json`;
            const r = await fetch(url);
            if (!r.ok) throw new Error('pageprops fetch failed');
            const j = await r.json();
            return j?.query?.pages || {};
        }

        async function getWikidataEntities(qids) {
            const ids = qids.join('|');
            const url = `${WDATA_API}&action=wbgetentities&ids=${ids}&props=labels|claims|sitelinks&languages=en&format=json`;
            const r = await fetch(url);
            if (!r.ok) throw new Error('wbgetentities failed');
            const j = await r.json();
            return j?.entities || {};
        }

        function extractDate(claim) {
            try {
                const time = claim?.mainsnak?.datavalue?.value?.time; // "+YYYY-MM-DDT.."
                if (!time) return null;
                const m = time.match(/([+-]?\d{1,4})-(\d{2})-(\d{2})/);
                if (!m) return null;
                const y = Number(m[1]); const mo = Number(m[2]); const d = Number(m[3]);
                return new Date(`${String(y).padStart(4, '0')}-${String(mo).padStart(2, '0')}-${String(d).padStart(2, '0')}T00:00:00Z`);
            } catch { return null; }
        }

        function hasInstanceOfHuman(claims) {
            const P31 = claims?.P31 || [];
            return P31.some(c => c?.mainsnak?.datavalue?.value?.id === 'Q5');
        }

        async function fetchTwoPeopleViaApis(attempts = 4, viewsThreshold = 50000, windowDays = 60) {
            for (let i = 0; i < attempts; i++) {
                const random = await getRandomPages(40);
                const pageids = random.map(p => p.id);
                const pagesObj = await getPageProps(pageids);
                const pages = Object.values(pagesObj);
                const qids = pages.map(p => p?.pageprops?.wikibase_item).filter(Boolean);
                if (qids.length === 0) continue;

                const entities = await getWikidataEntities(qids.slice(0, 50));
                const humans = [];
                for (const qid of Object.keys(entities)) {
                    const e = entities[qid];
                    if (!hasInstanceOfHuman(e.claims)) continue;

                    const dobClaim = (e.claims.P569 || [])[0];
                    const dodClaim = (e.claims.P570 || [])[0];
                    const dob = extractDate(dobClaim);
                    if (!dob) continue;
                    const dod = extractDate(dodClaim) || null;

                    // filter out NaN years
                    const birthYear = dob.getUTCFullYear();
                    if (Number.isNaN(birthYear)) continue;
                    if (dod !== null) {
                        const deathYear = dod.getUTCFullYear();
                        if (Number.isNaN(deathYear)) continue;
                    }

                    const title = e?.sitelinks?.enwiki?.title;
                    const article = title ? `https://en.wikipedia.org/wiki/${encodeURIComponent(title.replace(/ /g, '_'))}` : null;
                    const name = e?.labels?.en?.value || title || qid;
                    if (article) humans.push({ name, dob, dod, article, title });
                }

                // Popularity gate: check pageviews until we find 2 that clear the bar
                // Randomize order to keep variety
                for (let j = humans.length - 1; j > 0; j--) {
                    const k = Math.floor(Math.random() * (j + 1));
                    [humans[j], humans[k]] = [humans[k], humans[j]];
                }

                const picks = [];
                const cache = new Map(); // avoid duplicate pageview calls for same title in this loop

                for (const h of humans) {
                    const title = h.title || h.name;
                    let views = cache.get(title);
                    if (views === undefined) {
                        views = await getViewsLastNDays(title, windowDays);
                        cache.set(title, views);
                    }
                    if (views >= viewsThreshold) {
                        picks.push(h);
                        if (picks.length === 2) {
                            // strip the helper 'title' field before returning
                            return picks.map(({ title: _t, ...rest }) => rest);
                        }
                    }
                }
                // If not enough popular results, loop and try again
            }
            throw new Error('not enough humans after attempts (popularity filter too strict?)');
        }

        const SEED = [
            { name: "Albert Einstein", dob: new Date("1879-03-14"), dod: new Date("1955-04-18"), article: "https://en.wikipedia.org/wiki/Albert_Einstein" },
            { name: "Queen Elizabeth II", dob: new Date("1926-04-21"), dod: new Date("2022-09-08"), article: "https://en.wikipedia.org/wiki/Elizabeth_II" },
            { name: "Barack Obama", dob: new Date("1961-08-04"), dod: null, article: "https://en.wikipedia.org/wiki/Barack_Obama" },
            { name: "Frida Kahlo", dob: new Date("1907-07-06"), dod: new Date("1954-07-13"), article: "https://en.wikipedia.org/wiki/Frida_Kahlo" },
            { name: "Kurt Cobain", dob: new Date("1967-02-20"), dod: new Date("1994-04-05"), article: "https://en.wikipedia.org/wiki/Kurt_Cobain" },
            { name: "Freddie Mercury", dob: new Date("1946-09-05"), dod: new Date("1991-11-24"), article: "https://en.wikipedia.org/wiki/Freddie_Mercury" }
        ];

        async function fetchTwoPeople() {
            try { return await fetchTwoPeopleViaApis(); }
            catch (e) {
                console.warn('API pipeline failed, using seed.', e);
                const a = SEED[Math.floor(Math.random() * SEED.length)];
                let b = SEED[Math.floor(Math.random() * SEED.length)];
                while (b === a) b = SEED[Math.floor(Math.random() * SEED.length)];
                return [a, b];
            }
        }

        // ---------- State ----------
        let P1 = null, P2 = null;
        let minYear = 1900, maxYear = new Date().getUTCFullYear();
        let loading = false; let revealed = false;

        // ---------- DOM ----------
        const peopleEl = document.getElementById('people');
        const scaleEl = document.getElementById('scale');
        const startSlider = document.getElementById('startSlider');
        const endSlider = document.getElementById('endSlider');
        const startVal = document.getElementById('startVal');
        const endVal = document.getElementById('endVal');
        const submitBtn = document.getElementById('submit');
        const againBtn = document.getElementById('again');
        const resultEl = document.getElementById('result');
        const statusEl = document.getElementById('status');

        const canvas = document.getElementById('viz');
        const ctx = canvas.getContext('2d');

        function setStatus(msg, isErr = false) { statusEl.textContent = msg || ''; statusEl.className = isErr ? 'sub err' : 'sub'; }

        function renderPeople() {
            const rows = [P1, P2].map((p, i) => `
        <div class="person">
          <div class="name">${i === 0 ? 'A' : 'B'}. <a href="${p.article}" target="_blank" rel="noopener">${p.name}</a></div>
          <div class="years">${fmtYear(p.dob.getUTCFullYear())} – ${fmtYear((p.dod ? p.dod.getUTCFullYear() : null) ?? 'present')}</div>
        </div>
      `).join('');
            peopleEl.innerHTML = rows;
        }

        function renderScale() { scaleEl.innerHTML = `<div>${minYear}</div><div>${maxYear}</div>`; }

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const cssW = canvas.clientWidth; const cssH = canvas.clientHeight;
            canvas.width = Math.floor(cssW * dpr); canvas.height = Math.floor(cssH * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0); draw();
        }

        function yearToX(year) {
            const pad = 16; const w = canvas.clientWidth; const usable = Math.max(1, w - pad * 2);
            const t = (year - minYear) / (maxYear - minYear);
            return pad + clamp(t, 0, 1) * usable;
        }

        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        function draw() {
            clearCanvas(); if (!P1 || !P2) return;
            const h = canvas.clientHeight; const railY = h / 2; const railH = 12;
            ctx.fillStyle = '#0e1422'; ctx.fillRect(12, railY - railH / 2, canvas.clientWidth - 24, railH);
            ctx.strokeStyle = '#1e2435'; ctx.strokeRect(12, railY - railH / 2, canvas.clientWidth - 24, railH);

            const aL = yearToX(P1.dob.getUTCFullYear()); const aR = yearToX((P1.dod ? P1.dod.getUTCFullYear() : maxYear));
            const bL = yearToX(P2.dob.getUTCFullYear()); const bR = yearToX((P2.dod ? P2.dod.getUTCFullYear() : maxYear));
            ctx.fillStyle = 'rgba(94,157,200,0.75)'; ctx.fillRect(aL, railY - 10, Math.max(0, aR - aL), 8);
            ctx.fillStyle = 'rgba(53,199,109,0.75)'; ctx.fillRect(bL, railY + 2, Math.max(0, bR - bL), 8);

            if (revealed) {
                const oStart = Math.max(P1.dob.getUTCFullYear(), P2.dob.getUTCFullYear());
                const oEnd = Math.min((P1.dod ? P1.dod.getUTCFullYear() : maxYear), (P2.dod ? P2.dod.getUTCFullYear() : maxYear));
                if (oEnd > oStart) { ctx.fillStyle = 'rgba(94,157,200,0.45)'; const x1 = yearToX(oStart); const x2 = yearToX(oEnd); ctx.fillRect(x1, railY - 10, Math.max(0, x2 - x1), 20); }
            }

            const gs = +startSlider.value; const ge = +endSlider.value; const gx1 = yearToX(gs); const gx2 = yearToX(ge);
            ctx.fillStyle = 'rgba(242,184,75,0.35)'; ctx.fillRect(Math.min(gx1, gx2), railY - 12, Math.abs(gx2 - gx1), 24);
            ctx.fillStyle = '#a6aec4'; ctx.fillRect(gx1 - 1, railY - 16, 2, 32); ctx.fillRect(gx2 - 1, railY - 16, 2, 32);
            ctx.font = '12px Inter, system-ui, sans-serif'; ctx.fillStyle = '#a6aec4'; ctx.textAlign = 'center';
            ctx.fillText(String(gs), gx1, railY - 22); ctx.fillText(String(ge), gx2, railY - 22);
        }

        function setupSliders() {
            startSlider.min = endSlider.min = String(minYear);
            startSlider.max = endSlider.max = String(maxYear);
            const mid = Math.floor((minYear + maxYear) / 2);
            startSlider.value = String(mid - 5); endSlider.value = String(mid + 5);
            updateSliderLabels(); draw();
            startSlider.oninput = () => { if (+startSlider.value > +endSlider.value) endSlider.value = startSlider.value; updateSliderLabels(); draw(); };
            endSlider.oninput = () => { if (+endSlider.value < +startSlider.value) startSlider.value = endSlider.value; updateSliderLabels(); draw(); };
        }
        function updateSliderLabels() { startVal.textContent = `${startSlider.value}`; endVal.textContent = `${endSlider.value}`; }

        function computeAndReveal() {
            if (loading || !P1 || !P2) { setStatus('Still loading people. Try again in a moment.', true); return; }
            const gs = +startSlider.value; const ge = +endSlider.value;
            const aB = P1.dob.getUTCFullYear(); const aD = (P1.dod ? P1.dod.getUTCFullYear() : maxYear);
            const bB = P2.dob.getUTCFullYear(); const bD = (P2.dod ? P2.dod.getUTCFullYear() : maxYear);
            const trueOverlap = overlapYears(aB, aD, bB, bD); const guessOverlap = Math.max(0, ge - gs);
            const off = Math.abs(trueOverlap - guessOverlap); const score = Math.max(0, Math.round(100 - 4 * off));
            const coexistText = (trueOverlap > 0) ? `They overlapped for <b>${trueOverlap} year${trueOverlap === 1 ? '' : 's'}</b>.` : `They did <b>not</b> overlap.`;
            revealed = true; draw();
            resultEl.style.display = 'grid';
            resultEl.innerHTML = `<div class="score">Score: ${score}/100</div>
        <div>${coexistText} Your guess was <b>${guessOverlap}</b> — off by <b>${off}</b>.</div>
        <div class="muted">A: ${P1.name} (${aB}–${P1.dod ? aD : 'present'}) • B: ${P2.name} (${bB}–${P2.dod ? bD : 'present'})</div>`;
        }

        async function newRound() {
            loading = true; revealed = false; submitBtn.disabled = true;
            setStatus('Loading two random people…'); resultEl.style.display = 'none';
            try {
                const rows = await fetchTwoPeople();
                const nowYear = new Date().getUTCFullYear();
                const normalize = r => ({ name: r.name, article: r.article, dob: new Date(r.dob), dod: r.dod ? new Date(r.dod) : null });
                P1 = normalize(rows[0]); P2 = normalize(rows[1]);
                const allStart = Math.min(P1.dob.getUTCFullYear(), P2.dob.getUTCFullYear());
                const allEnd = Math.max(P1.dod ? P1.dod.getUTCFullYear() : nowYear, P2.dod ? P2.dod.getUTCFullYear() : nowYear);
                minYear = Math.max(1200, allStart - 2); maxYear = Math.min(nowYear, allEnd + 2);
                renderPeople(); renderScale(); setupSliders(); resizeCanvas(); setStatus(''); submitBtn.disabled = false;
            } catch (e) { console.error(e); setStatus("Couldn’t load people. Try again.", true); submitBtn.disabled = true; }
            finally { loading = false; }
        }

        window.addEventListener('resize', resizeCanvas);
        document.getElementById('submit').addEventListener('click', computeAndReveal);
        document.getElementById('again').addEventListener('click', newRound);

        newRound();
    </script>
</body>

</html>